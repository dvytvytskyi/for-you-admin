#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —è–∫—ñ —Å–µ—Ä–≤—ñ—Å–∏ –ø—Ä–∞—Ü—é—é—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
# –í–ò–ö–û–†–ò–°–¢–û–í–£–ô–¢–ï –¶–ï–ô –°–ö–†–ò–ü–¢ –ù–ê –°–ï–†–í–ï–†–Ü!

set -e

echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ—Ä–≤—ñ—Å—ñ–≤ —Ç–∞ –ø–æ—Ä—Ç—ñ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ..."
echo ""

# 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤
echo "üì¶ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ —Ç–∞ —ó—Ö –ø–æ—Ä—Ç–∏:"
echo "=========================================="
docker ps --format "table {{.Names}}\t{{.Ports}}" 2>/dev/null || echo "Docker –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–π"
echo ""

# 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –ø–æ—Ä—Ç—ñ–≤
echo "üåê –í—ñ–¥–∫—Ä–∏—Ç—ñ –ø–æ—Ä—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ:"
echo "=========================================="
netstat -tlnp 2>/dev/null | grep LISTEN | awk '{print $4 "\t" $7}' | head -20 || \
ss -tlnp 2>/dev/null | grep LISTEN | awk '{print $4 "\t" $6}' | head -20 || \
echo "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø–æ—Ä—Ç–∏"
echo ""

# 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–∏—Ö Node.js –ø—Ä–æ—Ü–µ—Å—ñ–≤
echo "üìã Node.js –ø—Ä–æ—Ü–µ—Å–∏:"
echo "=========================================="
ps aux | grep node | grep -v grep || echo "–ù–µ–º–∞—î –∑–∞–ø—É—â–µ–Ω–∏—Ö Node.js –ø—Ä–æ—Ü–µ—Å—ñ–≤"
echo ""

# 4. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Nginx –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π
echo "üåê Nginx –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó:"
echo "=========================================="
ls -la /etc/nginx/sites-enabled/ 2>/dev/null || echo "–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π"
echo ""

# 5. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —è–∫—ñ —Å–µ—Ä–≤—ñ—Å–∏ —Å–ª—É—Ö–∞—é—Ç—å –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 3000, 8080, 5000
echo "üîå –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω–∏—Ö –ø–æ—Ä—Ç—ñ–≤:"
echo "=========================================="
for port in 3000 3001 4000 5000 8080 8081; do
    if netstat -tln 2>/dev/null | grep -q ":${port} " || ss -tln 2>/dev/null | grep -q ":${port} "; then
        echo "‚úÖ –ü–æ—Ä—Ç ${port} - –ó–ê–ô–ù–Ø–¢–ò–ô"
        netstat -tlnp 2>/dev/null | grep ":${port} " | awk '{print "   –ü—Ä–æ—Ü–µ—Å: " $7}' || \
        ss -tlnp 2>/dev/null | grep ":${port} " | awk '{print "   –ü—Ä–æ—Ü–µ—Å: " $6}' || true
    else
        echo "‚ùå –ü–æ—Ä—Ç ${port} - –≤—ñ–ª—å–Ω–∏–π"
    fi
done
echo ""

# 6. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤ systemd
echo "‚öôÔ∏è  –ê–∫—Ç–∏–≤–Ω—ñ —Å–µ—Ä–≤—ñ—Å–∏ (systemd):"
echo "=========================================="
systemctl list-units --type=service --state=running | grep -E "(nginx|node|http|web|app)" || echo "–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤"
echo ""

echo "‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üí° –í–∏—Å–Ω–æ–≤–∫–∏:"
echo "   - –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Ü–µ—Å –Ω–∞ –ø–æ—Ä—Ç—É 3000 - —Ü–µ –º–æ–∂–µ –±—É—Ç–∏ –æ—Å–Ω–æ–≤–Ω–∏–π —Å–∞–π—Ç"
echo "   - –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Ü–µ—Å –Ω–∞ –ø–æ—Ä—Ç—É 8080/5000 - —Ü–µ –º–æ–∂–µ –±—É—Ç–∏ –æ—Å–Ω–æ–≤–Ω–∏–π —Å–∞–π—Ç"
echo "   - –Ø–∫—â–æ –ø–æ—Ä—Ç–∏ –≤—ñ–ª—å–Ω—ñ - –æ—Å–Ω–æ–≤–Ω–∏–π —Å–∞–π—Ç –º–æ–∂–µ –±—É—Ç–∏ —Å—Ç–∞—Ç–∏—á–Ω–∏–º –∞–±–æ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–º"
echo ""
echo "üìù –î–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∞–π—Ç—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ:"
echo "   ./deploy/setup-main-site.sh"
