#!/bin/bash

# –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∞–¥–º—ñ–Ω–∫–∏ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ
# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ: ssh root@135.181.201.185

set -e

PROJECT_DIR="/opt/admin-panel"
DOMAIN="admin.foryou-realestate.com"

echo "üîç –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∞–¥–º—ñ–Ω–∫–∏..."
echo ""

# 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤
echo "1Ô∏è‚É£ –°—Ç–∞—Ç—É—Å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤:"
echo "================================"
cd ${PROJECT_DIR} 2>/dev/null || {
    echo "‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ ${PROJECT_DIR}"
    exit 1
}

docker-compose -f docker-compose.prod.yml ps
echo ""

# 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤ backend
echo "2Ô∏è‚É£ –û—Å—Ç–∞–Ω–Ω—ñ 30 —Ä—è–¥–∫—ñ–≤ –ª–æ–≥—ñ–≤ backend:"
echo "================================"
docker-compose -f docker-compose.prod.yml logs --tail 30 admin-panel-backend 2>&1 || echo "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ª–æ–≥–∏"
echo ""

# 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤ frontend
echo "3Ô∏è‚É£ –û—Å—Ç–∞–Ω–Ω—ñ 30 —Ä—è–¥–∫—ñ–≤ –ª–æ–≥—ñ–≤ frontend:"
echo "================================"
docker-compose -f docker-compose.prod.yml logs --tail 30 admin-panel-frontend 2>&1 || echo "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ª–æ–≥–∏"
echo ""

# 4. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ backend –ª–æ–∫–∞–ª—å–Ω–æ
echo "4Ô∏è‚É£ –¢–µ—Å—Ç backend –ª–æ–∫–∞–ª—å–Ω–æ (–ø–æ—Ä—Ç 4000):"
echo "================================"
curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost:4000/health || echo "‚ùå Backend –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î"
echo ""

# 5. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ frontend –ª–æ–∫–∞–ª—å–Ω–æ
echo "5Ô∏è‚É£ –¢–µ—Å—Ç frontend –ª–æ–∫–∞–ª—å–Ω–æ (–ø–æ—Ä—Ç 3001):"
echo "================================"
curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost:3001 || echo "‚ùå Frontend –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î"
echo ""

# 6. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Nginx
echo "6Ô∏è‚É£ –°—Ç–∞—Ç—É—Å Nginx:"
echo "================================"
systemctl status nginx --no-pager -l | head -10 || echo "‚ùå Nginx –Ω–µ –ø—Ä–∞—Ü—é—î"
echo ""

# 7. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó Nginx
echo "7Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó Nginx:"
echo "================================"
nginx -t 2>&1 || echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó Nginx"
echo ""

# 8. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —â–æ Nginx —Å–ª—É—Ö–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω—ñ –ø–æ—Ä—Ç–∏
echo "8Ô∏è‚É£ Nginx —Å–ª—É—Ö–∞—î –ø–æ—Ä—Ç–∏:"
echo "================================"
netstat -tlnp | grep nginx | grep -E "80|443" || ss -tlnp | grep nginx | grep -E "80|443" || echo "‚ùå Nginx –Ω–µ —Å–ª—É—Ö–∞—î –ø–æ—Ä—Ç–∏ 80/443"
echo ""

# 9. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ DNS
echo "9Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ DNS –¥–ª—è ${DOMAIN}:"
echo "================================"
nslookup ${DOMAIN} || dig ${DOMAIN} || echo "‚ùå –ü—Ä–æ–±–ª–µ–º–∞ –∑ DNS"
echo ""

# 10. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–æ–≤–Ω—ñ—à–Ω—å–æ—ó –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ
echo "üîü –¢–µ—Å—Ç –∑–æ–≤–Ω—ñ—à–Ω—å–æ—ó –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ:"
echo "================================"
curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" -H "Host: ${DOMAIN}" http://localhost || echo "‚ùå –ù–µ –¥–æ—Å—Ç—É–ø–Ω–æ"
echo ""

# 11. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ—Ä—Ç—ñ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤
echo "1Ô∏è‚É£1Ô∏è‚É£ –ü–æ—Ä—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤:"
echo "================================"
docker ps --format "table {{.Names}}\t{{.Ports}}" | grep -E "admin|NAME" || echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω—ñ"
echo ""

# 12. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–µ—Ä–µ–∂—ñ Docker
echo "1Ô∏è‚É£2Ô∏è‚É£ Docker –º–µ—Ä–µ–∂–∞:"
echo "================================"
docker network ls | grep admin || echo "‚ùå –ú–µ—Ä–µ–∂–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞"
echo ""

echo "‚úÖ –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:"
echo "   - –Ø–∫—â–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω—ñ: docker-compose -f docker-compose.prod.yml up -d"
echo "   - –Ø–∫—â–æ Nginx –Ω–µ –ø—Ä–∞—Ü—é—î: systemctl restart nginx"
echo "   - –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∏ –≤ –ª–æ–≥–∞—Ö: docker-compose -f docker-compose.prod.yml logs -f"

