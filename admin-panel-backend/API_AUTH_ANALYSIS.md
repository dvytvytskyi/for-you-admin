# üîç –ê–Ω–∞–ª—ñ–∑ API Authentication - –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏

## ‚úÖ 1. –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∫–ª—é—á—ñ–≤ –≤ –ë–î

### –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏:
- **‚úÖ –ö–ª—é—á—ñ —ñ—Å–Ω—É—é—Ç—å –≤ –ë–î**
- **‚úÖ –ö–ª—é—á –∞–∫—Ç–∏–≤–Ω–∏–π** (`isActive = true`)
- **‚úÖ Secret —Å–ø—ñ–≤–ø–∞–¥–∞—î** (–ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ)
- **‚úÖ –ù–µ–º–∞—î –ø–æ–ª—è `expires_at`** (–∫–ª—é—á—ñ –Ω–µ –º–∞—é—Ç—å —Ç–µ—Ä–º—ñ–Ω—É –¥—ñ—ó)

### –î–µ—Ç–∞–ª—ñ –∫–ª—é—á–∞:
```
ID: 2ea96c29-fffb-4b03-93c7-acf265d032a4
API Key: ak_aa4d19418b385c370939b45365d0c687ddbdef7cbe9a72548748ef67f5e469e1
API Secret: as_623caef2632983630ce11293e544504c834a9ab1015fa2c75a7c2583d6f28d7c
Active: true
Last Used: Never
Created: 11/6/2025, 12:06:36 AM
```

---

## ‚úÖ 2. Middleware –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞

### –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
1. **–î–æ–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è** –≤ `authenticateApiKeyWithSecret`:
   - –õ–æ–≥—É–≤–∞–Ω–Ω—è –≤—Ö—ñ–¥–Ω–∏—Ö headers
   - –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∫–ª—é—á–∞ –≤ –ë–î
   - –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è secret
   - –î–µ—Ç–∞–ª—å–Ω—ñ –ø–æ–º–∏–ª–∫–∏ –∑ –ø—Ä–∏—á–∏–Ω–∞–º–∏

2. **–î–æ–¥–∞–Ω–æ trim() –¥–ª—è –∫–ª—é—á—ñ–≤** - –≤–∏–¥–∞–ª—è—î –ø—Ä–æ–±—ñ–ª–∏ –∑ –ø–æ—á–∞—Ç–∫—É/–∫—ñ–Ω—Ü—è

3. **–ü–æ–∫—Ä–∞—â–µ–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫**:
   - –û–∫—Ä–µ–º—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–ª—è –∫–ª—é—á–∞ —Ç–∞ secret
   - –î–µ—Ç–∞–ª—å–Ω—ñ –ª–æ–≥–∏ –¥–ª—è –¥–µ–±–∞–≥—É

### –õ–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏:
1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –∫–ª—é—á—ñ–≤
2. Trim –ø—Ä–æ–±—ñ–ª—ñ–≤
3. –ü–æ—à—É–∫ –∫–ª—é—á–∞ –≤ –ë–î (—Ç—ñ–ª—å–∫–∏ –ø–æ `apiKey`)
4. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ (`isActive`)
5. –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è secret (—Ç–æ—á–Ω–µ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è)
6. –û–Ω–æ–≤–ª–µ–Ω–Ω—è `lastUsedAt`

---

## ‚úÖ 3. –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –µ–Ω–¥–ø–æ—ñ–Ω—Ç—ñ–≤

### `/api/properties`:
- **‚úÖ Middleware –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ** (`router.use()`)
- **‚úÖ –ü—ñ–¥—Ç—Ä–∏–º—É—î API Key/Secret** (–ø–µ—Ä–µ–≤—ñ—Ä—è—î `x-api-key` —Ç–∞ `x-api-secret`)
- **‚úÖ –ü—ñ–¥—Ç—Ä–∏–º—É—î JWT** (fallback)
- **‚úÖ –î–æ–¥–∞–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è** –¥–ª—è –¥–µ–±–∞–≥—É

### `/api/public/data`:
- **‚úÖ Middleware –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ** (`authenticateApiKeyWithSecret`)
- **‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î –≤—Å—ñ properties** (–≤–∫–ª—é—á–Ω–æ –∑ secondary)
- **‚úÖ –î–æ–¥–∞–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è** —Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ `meta`

### –û–±—Ä–æ–±–∫–∞ `propertyType=secondary`:
- **‚úÖ –ü—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ** - —Ñ—ñ–ª—å—Ç—Ä—É—î —á–µ—Ä–µ–∑ `where.propertyType = 'secondary'`
- **‚úÖ –î–æ–¥–∞–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è** –∫—ñ–ª—å–∫–æ—Å—Ç—ñ secondary properties

---

## üß™ 4. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –°—Ç–≤–æ—Ä–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤–∏–π —Å–∫—Ä–∏–ø—Ç: `test-api.sh`

```bash
# –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–æ
./test-api.sh

# –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–∞ production
./test-api.sh https://admin.foryou-realestate.com
```

### –¢–µ—Å—Ç–∏:
1. ‚úÖ `/api/public/data` - –ø–æ–≤–µ—Ä—Ç–∞—î –≤—Å—ñ –¥–∞–Ω—ñ
2. ‚úÖ `/api/properties?propertyType=secondary` - –ø–æ–≤–µ—Ä—Ç–∞—î secondary properties
3. ‚úÖ `/api/properties` –∑ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏ - –ø—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ
4. ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–µ–∑ API –∫–ª—é—á—ñ–≤ - –ø–æ–≤–µ—Ä—Ç–∞—î 401/403

---

## üìä 5. –õ–æ–≥—É–≤–∞–Ω–Ω—è –Ω–∞ backend

### –î–æ–¥–∞–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤:

#### `authenticateApiKeyWithSecret`:
```
[API Auth] Incoming request: { hasApiKey, hasApiSecret, apiKeyPrefix, ... }
[API Auth] ‚úÖ API key found in database: { id, name, isActive, ... }
[API Auth] ‚úÖ Authentication successful
```

#### `/api/properties`:
```
[Properties API] GET /api/properties request: { query, propertyType, authMethod }
[Properties API] Query results: { totalProperties, secondaryProperties, ... }
[Properties API] ‚úÖ Response sent: { totalProperties }
```

#### `/api/public/data`:
```
[Public API] GET /api/public/data request: { hasApiKey, apiKeyName }
[Public API] ‚úÖ Response sent: { totalProperties, secondaryProperties, ... }
```

---

## üîß –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —Ç–∞ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è

### 1. –î–æ–¥–∞–Ω–æ trim() –¥–ª—è –∫–ª—é—á—ñ–≤
```typescript
const trimmedApiKey = apiKey.trim();
const trimmedApiSecret = apiSecret.trim();
```

### 2. –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
- –°–ø–æ—á–∞—Ç–∫—É —à—É–∫–∞—î –∫–ª—é—á –ø–æ `apiKey`
- –ü–æ—Ç—ñ–º –ø–µ—Ä–µ–≤—ñ—Ä—è—î –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å
- –ü–æ—Ç—ñ–º –ø–æ—Ä—ñ–≤–Ω—é—î secret
- –î–µ—Ç–∞–ª—å–Ω—ñ –ª–æ–≥–∏ –Ω–∞ –∫–æ–∂–Ω–æ–º—É –µ—Ç–∞–ø—ñ

### 3. –î–æ–¥–∞–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ `/api/public/data`
```json
{
  "meta": {
    "totalProperties": 28782,
    "totalSecondaryProperties": 27852,
    "totalOffPlanProperties": 930,
    ...
  }
}
```

---

## üö® –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏ —Ç–∞ —Ä—ñ—à–µ–Ω–Ω—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: "Invalid API key or secret"
**–ü—Ä–∏—á–∏–Ω–∏:**
1. –ö–ª—é—á –Ω–µ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –≤ headers
2. –ö–ª—é—á –º–∞—î –ø—Ä–æ–±—ñ–ª–∏ (–≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ - –¥–æ–¥–∞–Ω–æ trim())
3. Secret –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—î (–ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è –≤ –ª–æ–≥–∞—Ö)

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ `[API Auth]` –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
- –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –∫–ª—é—á—ñ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è —è–∫ `x-api-key` —Ç–∞ `x-api-secret`
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ –∫–ª—é—á—ñ –Ω–µ –º–∞—é—Ç—å –ø—Ä–æ–±—ñ–ª—ñ–≤

### –ü—Ä–æ–±–ª–µ–º–∞ 2: 403 Forbidden
**–ü—Ä–∏—á–∏–Ω–∏:**
1. –ö–ª—é—á –Ω–µ –∞–∫—Ç–∏–≤–Ω–∏–π (`isActive = false`)
2. Secret –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—î
3. –ö–ª—é—á –Ω–µ —ñ—Å–Ω—É—î –≤ –ë–î

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ `[API Auth]` - –ø–æ–∫–∞–∂–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É –ø—Ä–∏—á–∏–Ω—É
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–ª—é—á —á–µ—Ä–µ–∑ `npm run check:api-keys-detail`

### –ü—Ä–æ–±–ª–µ–º–∞ 3: Headers –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è
**–ü—Ä–∏—á–∏–Ω–∏:**
1. CORS –±–ª–æ–∫—É—î –∫–∞—Å—Ç–æ–º–Ω—ñ headers
2. Frontend –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î headers –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ CORS –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –Ω–∞ backend
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ frontend –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î headers:
  ```javascript
  headers: {
    'x-api-key': 'ak_...',
    'x-api-secret': 'as_...'
  }
  ```

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å backend** - —â–æ–± –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–∏ –∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è–º
2. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏** –ø—Ä–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—ñ - –¥–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–æ–∂–µ–Ω –∑–∞–ø–∏—Ç
3. **–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–∏–π —Å–∫—Ä–∏–ø—Ç** - `./test-api.sh` –¥–ª—è —à–≤–∏–¥–∫–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
4. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ frontend** - —á–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è headers

---

## üéØ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

1. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å backend —Å–µ—Ä–≤–µ—Ä
2. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ —á–µ—Ä–µ–∑ `./test-api.sh`
3. ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ backend –ø—Ä–∏ –∑–∞–ø–∏—Ç—ñ –∑ frontend
4. ‚úÖ –Ø–∫—â–æ –ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è - –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ CORS –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

---

## üìû –ö–æ–º–∞–Ω–¥–∏ –¥–ª—è –¥–µ–±–∞–≥—É

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–ª—é—á—ñ –≤ –ë–î
npm run check:api-keys-detail

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ active –∫–ª—é—á—ñ
npm run test:api-auth

# –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π —Ç–µ—Å—Ç–æ–≤–∏–π –∫–ª—é—á
npm run create:test-api-key

# –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è API
./test-api.sh https://admin.foryou-realestate.com
```

---

**–î–∞—Ç–∞ –∞–Ω–∞–ª—ñ–∑—É:** 2025-11-06  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω–æ, –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ

