# üîß –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º –∑ API Key/Secret

## –ü—Ä–æ–±–ª–µ–º–∞

API –∑–∞–ø–∏—Ç–∏ –∑ `x-api-key` —Ç–∞ `x-api-secret` –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å `403 Forbidden` –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º `"Invalid API key or secret"`.

## –ö—Ä–æ–∫ 1: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–ª—é—á—ñ–≤ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö

–ó–∞–ø—É—Å—Ç—ñ—Ç—å –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–∏–π —Å–∫—Ä–∏–ø—Ç:

```bash
cd admin-panel-backend
npm run check:api-keys-production
```

–°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å:
- ‚úÖ –ß–∏ —ñ—Å–Ω—É—é—Ç—å –∫–ª—é—á—ñ –≤ –ë–î
- ‚úÖ –ß–∏ –∞–∫—Ç–∏–≤–Ω—ñ –∫–ª—é—á—ñ (`isActive = true`)
- ‚úÖ –§–æ—Ä–º–∞—Ç –∫–ª—é—á—ñ–≤ (–ø—Ä–µ—Ñ—ñ–∫—Å–∏ `ak_`, `fyr_`, –∞–±–æ –±–µ–∑ –ø—Ä–µ—Ñ—ñ–∫—Å—É)
- ‚úÖ –ß–∏ –∑–±—ñ–≥–∞—é—Ç—å—Å—è secret –∑ –∑–∞–ø–∏—Ç–æ–º
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—Å—ñ—Ö –∫–ª—é—á–∞—Ö

## –ö—Ä–æ–∫ 2: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞ –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ –ø—Ä–µ—Ñ—ñ–∫—Å–∞–º–∏

–Ø–∫—â–æ –∫–ª—é—á—ñ–≤ –Ω–µ–º–∞—î –∞–±–æ –≤–æ–Ω–∏ –º–∞—é—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç, —Å—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π:

```bash
cd admin-panel-backend
npm run create:api-key-prefixes
```

–¶–µ–π —Å–∫—Ä–∏–ø—Ç —Å—Ç–≤–æ—Ä–∏—Ç—å –∫–ª—é—á –∑ –ø—Ä–µ—Ñ—ñ–∫—Å–∞–º–∏:
- `ak_` –¥–ª—è API Key
- `as_` –¥–ª—è API Secret

## –ö—Ä–æ–∫ 3: –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∫–ª—é—á—ñ–≤ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω

–Ø–∫—â–æ –ª–æ–∫–∞–ª—å–Ω–æ –≤—Å–µ –ø—Ä–∞—Ü—é—î (–∫–ª—é—á—ñ —î, –∞–∫—Ç–∏–≤–Ω—ñ, —Ñ–æ—Ä–º–∞—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π), –∞–ª–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω –Ω–µ –ø—Ä–∞—Ü—é—î, –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –∫–ª—é—á—ñ:

### –í–∞—Ä—ñ–∞–Ω—Ç A: –ï–∫—Å–ø–æ—Ä—Ç —É SQL —Ñ–∞–π–ª (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)

```bash
cd admin-panel-backend
npm run export:api-keys-sql
```

–¶–µ —Å—Ç–≤–æ—Ä–∏—Ç—å —Ñ–∞–π–ª `api-keys-export.sql` –∑ —É—Å—ñ–º–∞ –∫–ª—é—á–∞–º–∏. –ü–æ—Ç—ñ–º:

1. –°–∫–æ–ø—ñ—é–π—Ç–µ —Ñ–∞–π–ª –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä
2. –ü—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –¥–æ –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î:
   ```bash
   psql -h <host> -U <user> -d <database>
   ```
3. –í–∏–∫–æ–Ω–∞–π—Ç–µ SQL —Ñ–∞–π–ª:
   ```sql
   \i api-keys-export.sql
   ```

### –í–∞—Ä—ñ–∞–Ω—Ç B: –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è

```bash
cd admin-panel-backend
npm run sync:api-keys
```

–°–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∂–µ SQL –∫–æ–º–∞–Ω–¥–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω.

## –ö—Ä–æ–∫ 4: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä—ñ

–ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è middleware, –≤—Å—ñ –∑–∞–ø–∏—Ç–∏ –ª–æ–≥—É—é—Ç—å—Å—è –¥–µ—Ç–∞–ª—å–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏:

```bash
# –ù–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä—ñ
tail -f /var/log/admin-backend/app.log | grep "\[API Auth\]"
```

–ê–±–æ –≤ –∫–æ–Ω—Å–æ–ª—ñ —Å–µ—Ä–≤–µ—Ä–∞ –≤–∏ –ø–æ–±–∞—á–∏—Ç–µ:

```
[API Auth] ========================================
[API Auth] Incoming request: { url: '/api/public/data', method: 'GET', ... }
[API Auth] Headers check: { 'x-api-key': true, 'X-Api-Key': false, ... }
[API Auth] Extracted values: { hasApiKey: true, hasApiSecret: true, ... }
[API Auth] ‚úÖ API key found in database: { ... }
[API Auth] ‚úÖ Authentication successful
[API Auth] ========================================
```

## –©–æ –±—É–ª–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. Case-insensitive –∑–∞–≥–æ–ª–æ–≤–∫–∏

Middleware —Ç–µ–ø–µ—Ä –ø—ñ–¥—Ç—Ä–∏–º—É—î —Ä—ñ–∑–Ω—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ —Ä–µ–≥—ñ—Å—Ç—Ä—É:
- `x-api-key` / `X-Api-Key` / `X-API-KEY`
- `x-api-secret` / `X-Api-Secret` / `X-API-SECRET`

### 2. –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —Ä—ñ–∑–Ω–∏—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤ –∫–ª—é—á—ñ–≤

Middleware –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –∑–Ω–∞–π—Ç–∏ –∫–ª—é—á —É –∫—ñ–ª—å–∫–æ—Ö –≤–∞—Ä—ñ–∞–Ω—Ç–∞—Ö:
- –¢–æ—á–Ω–∏–π –∑–±—ñ–≥
- –ë–µ–∑ –ø—Ä–µ—Ñ—ñ–∫—Å—É `ak_` (—è–∫—â–æ –≤ –ë–î –±–µ–∑ –ø—Ä–µ—Ñ—ñ–∫—Å—É)
- –ó –ø—Ä–µ—Ñ—ñ–∫—Å–æ–º `fyr_` (—è–∫—â–æ –≤ –ë–î –∑ `fyr_`, –∞ –∑–∞–ø–∏—Ç –∑ `ak_`)

### 3. –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –ø—Ä–µ—Ñ—ñ–∫—Å—ñ–≤ –¥–ª—è secret

–Ø–∫—â–æ secret –º–∞—î –ø—Ä–µ—Ñ—ñ–∫—Å `as_`, middleware —Å–ø—Ä–æ–±—É—î –∑–Ω–∞–π—Ç–∏ –±–µ–∑ –ø—Ä–µ—Ñ—ñ–∫—Å—É.

### 4. –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è

–î–æ–¥–∞–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è:
- –í—Å—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
- –ü—Ä–µ—Ñ—ñ–∫—Å–∏ –∫–ª—é—á—ñ–≤ (–±–µ–∑ –ø–æ–≤–Ω–æ–≥–æ –≤–∏–≤–æ–¥—É –¥–ª—è –±–µ–∑–ø–µ–∫–∏)
- –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –¥–æ–≤–∂–∏–Ω —Ç–∞ –ø—Ä–µ—Ñ—ñ–∫—Å—ñ–≤
- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫–ª—é—á—ñ–≤ —É –ë–î (—è–∫—â–æ –∫–ª—é—á –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ)
- –ü–æ–∫—Ä–æ–∫–æ–≤–µ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è secret (–ø–µ—Ä—à–∞ –≤—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å)

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –¢–µ—Å—Ç 1: –ó –Ω–∏–∂–Ω—ñ–º —Ä–µ–≥—ñ—Å—Ç—Ä–æ–º (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)

```bash
curl -H "x-api-key: ak_aa4d19418b385c370939b45365d0c687ddbdef7cbe9a72548748ef67f5e469e1" \
     -H "x-api-secret: as_623caef2632983630ce11293e544504c834a9ab1015fa2c75a7c2583d6f28d7c" \
     https://admin.foryou-realestate.com/api/public/data
```

### –¢–µ—Å—Ç 2: –ó –≤–µ—Ä—Ö–Ω—ñ–º —Ä–µ–≥—ñ—Å—Ç—Ä–æ–º

```bash
curl -H "X-Api-Key: ak_aa4d19418b385c370939b45365d0c687ddbdef7cbe9a72548748ef67f5e469e1" \
     -H "X-Api-Secret: as_623caef2632983630ce11293e544504c834a9ab1015fa2c75a7c2583d6f28d7c" \
     https://admin.foryou-realestate.com/api/public/data
```

## –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏ —Ç–∞ —Ä—ñ—à–µ–Ω–Ω—è

### –ü—Ä–æ–±–ª–µ–º–∞: "API key not found in database"

**–†—ñ—à–µ–Ω–Ω—è:**
1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ —ñ—Å–Ω—É—î –∫–ª—é—á –≤ –ë–î: `npm run check:api-keys-production`
2. –Ø–∫—â–æ –∫–ª—é—á–∞ –Ω–µ–º–∞—î, —Å—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π: `npm run create:api-key-prefixes`
3. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –∫–ª—é—á –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º –ø—Ä–µ—Ñ—ñ–∫—Å–æ–º

### –ü—Ä–æ–±–ª–µ–º–∞: "API key is not active"

**–†—ñ—à–µ–Ω–Ω—è:**
1. –ê–∫—Ç–∏–≤—É–π—Ç–µ –∫–ª—é—á —á–µ—Ä–µ–∑ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å (`/integrations`)
2. –ê–±–æ –≤—Ä—É—á–Ω—É –≤ –ë–î: `UPDATE api_keys SET is_active = true WHERE api_key = '...'`

### –ü—Ä–æ–±–ª–µ–º–∞: "API secret does not match"

**–†—ñ—à–µ–Ω–Ω—è:**
1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ—Å—Ç—å secret –≤ –∑–∞–ø–∏—Ç—ñ
2. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ secret –Ω–µ –º–∞—î –∑–∞–π–≤–∏—Ö –ø—Ä–æ–±—ñ–ª—ñ–≤
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ secret –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∑ –ø—Ä–µ—Ñ—ñ–∫—Å–æ–º `as_` –≤ –ë–î (middleware —Ç–µ–ø–µ—Ä –ø—ñ–¥—Ç—Ä–∏–º—É—î –æ–±–∏–¥–≤–∞ –≤–∞—Ä—ñ–∞–Ω—Ç–∏)

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–ª—é—á—ñ –≤ –ë–î –º–∞—é—Ç—å —Ñ–æ—Ä–º–∞—Ç `fyr_`, –∞ –∑–∞–ø–∏—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `ak_`

**–†—ñ—à–µ–Ω–Ω—è:**
1. Middleware —Ç–µ–ø–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –æ–±–∏–¥–≤–∞ —Ñ–æ—Ä–º–∞—Ç–∏
2. –ê–±–æ —Å—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –∫–ª—é—á –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º —Ñ–æ—Ä–º–∞—Ç–æ–º: `npm run create:api-key-prefixes`

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ñ api_keys

```sql
CREATE TABLE api_keys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  api_key VARCHAR UNIQUE NOT NULL,
  api_secret VARCHAR NOT NULL,
  name VARCHAR,
  is_active BOOLEAN DEFAULT true,
  last_used_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

## –ü—Ä–∏–∫–ª–∞–¥ SQL –∑–∞–ø–∏—Ç—ñ–≤ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```sql
-- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—Å—ñ—Ö –∫–ª—é—á—ñ–≤
SELECT id, name, api_key, LEFT(api_secret, 20) as secret_prefix, is_active, last_used_at
FROM api_keys
ORDER BY created_at DESC;

-- –ü–æ—à—É–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
SELECT * FROM api_keys 
WHERE api_key = 'ak_aa4d19418b385c370939b45365d0c687ddbdef7cbe9a72548748ef67f5e469e1';

-- –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∫–ª—é—á–∞
SELECT is_active FROM api_keys 
WHERE api_key = 'ak_aa4d19418b385c370939b45365d0c687ddbdef7cbe9a72548748ef67f5e469e1';
```

## –û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω

–ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å:

1. –ó–∞–∫–æ–º—ñ—Ç—å—Ç–µ –∑–º—ñ–Ω–∏:
```bash
git add .
git commit -m "Fix API authentication: case-insensitive headers, multiple key formats, detailed logging"
git push
```

2. –ù–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä—ñ:
```bash
cd /path/to/admin-panel-backend
git pull
npm install  # —è–∫—â–æ —î –Ω–æ–≤—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
npm run build
pm2 restart admin-backend  # –∞–±–æ –≤–∞—à –ø—Ä–æ—Ü–µ—Å –º–µ–Ω–µ–¥–∂–µ—Ä
```

3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏:
```bash
pm2 logs admin-backend | grep "\[API Auth\]"
```

## –ö–æ–Ω—Ç–∞–∫—Ç–∏

–Ø–∫—â–æ –ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è, –Ω–∞–¥–∞–π—Ç–µ:
1. –í–∏–≤—ñ–¥ –∑ `npm run check:api-keys-production`
2. –õ–æ–≥–∏ –∑ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞ (–æ—Å—Ç–∞–Ω–Ω—ñ 50 —Ä—è–¥–∫—ñ–≤)
3. –ü—Ä–∏–∫–ª–∞–¥ curl –∑–∞–ø–∏—Ç—É, —è–∫–∏–π –Ω–µ –ø—Ä–∞—Ü—é—î

